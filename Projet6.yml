## This script is made for automatize the deployment of EC2 instances on AWS
## You must untag the single tagged line bellow and modify it with your own configuration

---
  - name: Create EC2 instance
    hosts: local
    connection: local
    gather_facts: False
    tags: provisioning
## required parameters :
    vars:
#      instance_type: t2.micro
#      security_group: Admin
#      image: ami-095********
#      keypair: awsp5
#      region: eu-west-3
#      count: 2
 
## Task that will be used to Launch/Create an EC2 Instance. There is basic firewall rules, you can add somes bellow.
    tasks:
 
      - name: Create a security group
        local_action: 
          module: ec2_group
          name: "{{ security_group }}"
#          description: Sec-grp
          region: "{{ region }}"
          rules:
            - proto: tcp
              from_port: 22
              to_port: 22
              cidr_ip: 0.0.0.0/0
            - proto: tcp
              from_port: 8080
              to_port: 8080
              cidr_ip: 0.0.0.0/0
            - proto: tcp
              from_port: 443
              to_port: 443
              cidr_ip: 0.0.0.0/0
          rules_egress:
            - proto: all
              cidr_ip: 0.0.0.0/0
        register: basic_firewall
        
## Creating the new Instances by using the vars set before.
      - name: New EC2 Instance
        local_action: ec2 
                      group={{ security_group }} 
                      instance_type={{ instance_type}} 
                      image={{ image }} 
                      wait=true
                      wait_timeout=500 
                      region="{{ region }}" 
                      keypair={{ keypair }}
                      count={{count}}
#        register: ec2_awsp6
 
      - name: Add the newly created EC2 instance(s) to the local host group
## Set the log file to use :
        local_action: lineinfile 
                     # path=/mypath/to/logfile.txt
                      regexp={{ item.public_ip }} 
#                      insertafter='\[awsp6\]' line={{ item.public_ip }}
#        with_items: '{{ec2_awsp6.instances}}'
 
      - name: Add new instance to host group
        add_host:
          hostname: "{{ item.public_ip }}"
          groupname: launched
#        with_items: "{{ ec2_awsp6.instances }}"
 
      - name: Let's wait for SSH to come up. Usually that takes ~10 seconds
        local_action: wait_for 
                      host={{ item.public_ip }} 
                      port=22 
                      state=started
 #       with_items: '{{ ec2_awsp6.instances }}'
 ## You can change Instance's tag after" Name:".
      - name: Add tag to Instance(s)
        local_action: ec2_tag resource={{ item.id }} region={{ region }} state=present
#        with_items: '{{ ec2_awsp6.instances }}'
        args:
          tags:
#            Name: awsp6

